# mdb-vs
kitchensink for mdb-vs index management

---

# MongoDB Atlas Vector Search with Azure OpenAI

A Python script demonstrating end-to-end semantic search on MongoDB. It uses Azure OpenAI to generate vector embeddings from a text query and uses MongoDB Atlas's `$vectorSearch` to find documents based on conceptual meaning.

### Core Functionality

  * **Vector Generation**: Converts natural language queries into `text-embedding-ada-002` embeddings via the Azure OpenAI API.
  * **Index Management**: Programmatically creates a `vectorSearch` index on a collection, checking for its existence and polling its status until `READY`.
  * **Semantic Search**: Executes a `$vectorSearch` aggregation pipeline to find documents with the most similar vector embeddings.
  * **Cleanup**: Includes a prompt to drop the search index after the demonstration.

-----


## Setup & Run

### 1\. Prerequisites

* **MongoDB Tools:**
  * **mongosh:** The official MongoDB shell for interacting with MongoDB databases.
  * **mongorestore:** A tool for restoring data from a dump file to a MongoDB database.
* **Docker:** Installed on your system ([https://www.docker.com/products/docker-desktop/](https://www.docker.com/products/docker-desktop/))
* **wget or curl:** Installed on your system (package managers usually handle this)


### Setting Up a Local Atlas Environment

1. **Pull the Docker Image:**

   * **Latest Version:**
     ```bash
     docker pull mongodb/mongodb-atlas-local
     ```

2. **Run the Database:**

   ```bash
   docker run -p 27017:27017 mongodb/mongodb-atlas-local
   ```
   This command runs the Docker image, exposing port 27017 on your machine for connecting to the database.

### Using Sample Datasets with MongoDB

This section demonstrates downloading and exploring a sample dataset for MongoDB on your local system.

#### Downloading the Dataset

There's a complete sample dataset available for MongoDB. Download it using either `wget` or `curl`:

* **Using wget:**

```bash
wget https://atlas-education.s3.amazonaws.com/sampledata.archive
```

* **Using curl:**

```bash
curl https://atlas-education.s3.amazonaws.com/sampledata.archive -o sampledata.archive
```

**Note:**

* Ensure you have `wget` or `curl` installed.
* The downloaded file will be named `sampledata.archive`.

#### Restoring the Dataset

Before restoring, ensure you have a local `mongod` instance running (either existing or newly started). This instance will host the dataset.

**To restore the dataset:**

```bash
mongorestore --archive=sampledata.archive
```

This command uses the `mongorestore` tool to unpack the downloaded archive (`sampledata.archive`) and populate your local `mongod` instance with the sample data.


### 2\. Execute

Run the script from your terminal. It will guide you through index creation and the search.

```bash
python demo.py
```

-----

## Key Components

### Vector Index Definition

The script defines the `vectorSearch` index, specifying the vector field, dimensions, and similarity metric.

```python
# From the script
search_index_model = SearchIndexModel(
    name="vector_index_plot",
    type="vectorSearch",
    definition={
        "fields": [
            {
                "type": "vector",
                "path": "plot_embedding",
                "numDimensions": 1536,
                "similarity": "cosine",
            }
        ]
    }
)
```

### `$vectorSearch` Aggregation Pipeline

The core search logic is an aggregation pipeline that finds the top N results based on vector similarity and projects the search score.

  * `queryVector`: The embedding generated from the user's text query.
  * `numCandidates`: The number of nodes to inspect during the search for higher accuracy.
  * `$meta: "vectorSearchScore"`: Projects the similarity score of each result.

<!-- end list -->

```python
# From the script
pipeline = [
    {
        "$vectorSearch": {
            "index": "vector_index_plot",
            "path": "plot_embedding",
            "queryVector": query_vector, # Generated by Azure OpenAI
            "numCandidates": 150,
            "limit": 5,
        }
    },
    {
        "$project": {
            "title": 1,
            "plot": 1,
            "score": { "$meta": "vectorSearchScore" }
        }
    }
]
```

### Example Output

Searching for `"A tale of redemption and friendship in a prison."` yields the following:

```
--- Search Results ---
  ðŸŽ¬ Title: The Shawshank Redemption
      Score: 0.9416
      Plot: Two imprisoned men bond over a number of years, finding solace and eventual redemption through acts of common decency....

  ðŸŽ¬ Title: The Green Mile
      Score: 0.9023
      Plot: The lives of guards on Death Row are affected by one of their charges: a black man accused of child murder and rape, yet who has a mysterious gift....
```

----

## FULL CODE

```
# This script adds Azure OpenAI to generate
# a query vector and then performs a search.

# Ensure you have the necessary libraries installed:
# pip install pymongo openai python-dotenv

import pymongo
import os
import time
import openai
from dotenv import load_dotenv
from pymongo.errors import OperationFailure, ConnectionFailure, ConfigurationError
from pymongo.operations import SearchIndexModel

# --- Configuration ---
# Load environment variables from a .env file for security
load_dotenv()

ATLAS_CONNECTION_STRING = "mongodb://localhost:27017/?retryWrites=true&w=majority&directConnection=true"
DB_NAME = "sample_mflix"
COLLECTION_NAME = "embedded_movies"
INDEX_NAME = "vector_index_plot"
VECTOR_FIELD_PATH = "plot_embedding"
VECTOR_DIMENSIONS = 1536  # Dimensions for OpenAI's text-embedding-ada-002

def generate_embedding(text: str, client: openai.AzureOpenAI) -> list[float]:
    """
    Generates a vector embedding for a given text using Azure OpenAI.
    """
    print(f"[INFO] Generating embedding for query: '{text}'")
    try:
        # Note: The 'model' parameter for Azure OpenAI refers to your deployment name.
        deployment_name = "text-embedding-ada-002"  # Change this to your deployment name
        if not deployment_name:
            raise ValueError("[FATAL] AZURE_OAI_DEPLOYMENT environment variable not set.")
            
        response = client.embeddings.create(input=[text], model=deployment_name)
        return response.data[0].embedding
    except Exception as e:
        print(f"[ERROR] Failed to generate embedding: {e}")
        return None

def main():
    """
    Main function to connect to MongoDB, manage vector indexes, and run a vector search.
    """
    print("--- MongoDB & Azure OpenAI Vector Search Example (2025) ---")

    mongo_client = None
    try:
        # 1. Connect to MongoDB Atlas
        print("\n[INFO] Connecting to MongoDB Atlas cluster...")
        if not ATLAS_CONNECTION_STRING or "<username>" in ATLAS_CONNECTION_STRING:
            print("[FATAL] Please set your ATLAS_CONNECTION_STRING in the .env file.")
            return

        mongo_client = pymongo.MongoClient(ATLAS_CONNECTION_STRING)
        mongo_client.admin.command('ping')
        print("[SUCCESS] MongoDB connection successful.")

        db = mongo_client[DB_NAME]
        collection = db[COLLECTION_NAME]

        # 2. Define the Vector Search Index
        print("[INFO] Defining Vector Search index model...")
        search_index_model = SearchIndexModel(
            name=INDEX_NAME,
            type="vectorSearch",
            definition={
                "fields": [
                    {
                        "type": "vector",
                        "path": VECTOR_FIELD_PATH,
                        "numDimensions": VECTOR_DIMENSIONS,
                        "similarity": "cosine",
                    }
                ]
            }
        )

        # 3. Create the Vector Search Index (if it doesn't exist)
        print(f"\n[ACTION] Checking/Creating index '{INDEX_NAME}'...")
        try:
            # Check for existing index first to avoid unnecessary waits
            existing_indexes = [idx['name'] for idx in collection.list_search_indexes()]
            if INDEX_NAME in existing_indexes:
                 print(f"[WARN] Index '{INDEX_NAME}' already exists. Skipping creation.")
            else:
                collection.create_search_index(model=search_index_model)
                print(f"[SUCCESS] Index creation command sent for '{INDEX_NAME}'. Monitoring status...")
                # Monitor index build status
                while True:
                    index_status = list(collection.list_search_indexes(name=INDEX_NAME))
                    if not index_status:
                        print("[INFO] Waiting for index creation to initialize...")
                        time.sleep(10)
                        continue
                    status = index_status[0].get('status')
                    print(f"[INFO] Current index status: {status}")
                    if status == 'READY':
                        print("[SUCCESS] Index is built and ready for use. âœ…")
                        break
                    elif status == 'FAILED':
                        print("[ERROR] Index creation failed. Check the Atlas UI for details.")
                        return
                    time.sleep(10)
        except OperationFailure as e:
            # Handle cases where the index was created between the check and the create call
            if "already exists" in str(e):
                print(f"[WARN] Index '{INDEX_NAME}' already exists.")
            else:
                print(f"[ERROR] An error occurred: {e}")
                return

        # 4. Perform a Vector Search using Azure OpenAI
        user_input = input(f"\n[PROMPT] Do you want to perform a vector search? (yes/no): ").lower()
        if user_input == 'yes':
            print("\n[ACTION] Initializing Azure OpenAI client...")
            try:
                # Setup Azure OpenAI client
                azure_oai_client = openai.AzureOpenAI(
                    api_key="",
                    api_version="2023-05-15", # A common, stable version
                    azure_endpoint="https://.openai.azure.com"
                )
                
                query_text = "A tale of redemption and friendship in a prison."
                query_vector = generate_embedding(query_text, azure_oai_client)

                if query_vector:
                    print("[INFO] Executing $vectorSearch aggregation...")
                    pipeline = [
                        {
                            "$vectorSearch": {
                                "index": INDEX_NAME,
                                "path": VECTOR_FIELD_PATH,
                                "queryVector": query_vector,
                                "numCandidates": 150, # Number of candidates to consider
                                "limit": 5, # Number of results to return
                            }
                        },
                        {
                            "$project": {
                                "title": 1,
                                "plot": 1,
                                "score": { "$meta": "vectorSearchScore" } # Include the search score
                            }
                        }
                    ]
                    results = collection.aggregate(pipeline)
                    print("\n--- Search Results ---")
                    for doc in results:
                        print(f"  ðŸŽ¬ Title: {doc['title']}\n"
                              f"     Score: {doc['score']:.4f}\n"
                              f"     Plot: {doc['plot'][:150]}...\n")

            except Exception as e:
                print(f"[FATAL] An error occurred during the search operation: {e}")

        # 5. List and Drop Index
        print(f"\n[INFO] Current search indexes for '{COLLECTION_NAME}':")
        for idx in collection.list_search_indexes():
            print(f"  - Name: {idx['name']}, Status: {idx.get('status', 'N/A')}")
        
        user_input = input(f"\n[PROMPT] Do you want to drop the index '{INDEX_NAME}'? (yes/no): ").lower()
        if user_input == 'yes':
            print(f"\n[ACTION] Dropping index '{INDEX_NAME}'...")
            collection.drop_search_index(INDEX_NAME)
            print(f"[SUCCESS] Index '{INDEX_NAME}' dropped.")
        else:
            print("\n[INFO] Skipping index drop.")

    except ConfigurationError as e:
        print(f"[FATAL] Configuration error: {e}")
    except ConnectionFailure as e:
        print(f"[FATAL] Connection failed: {e}")
    except Exception as e:
        print(f"[FATAL] An unexpected error occurred: {e}")
    finally:
        if mongo_client:
            mongo_client.close()
            print("\n[INFO] MongoDB connection closed.")

if __name__ == "__main__":
    main()
```

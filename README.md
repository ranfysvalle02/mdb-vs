# mdb-vs
kitchensink for mdb-vs index management

---

# MongoDB Atlas Vector Search with Azure OpenAI

A Python script demonstrating end-to-end semantic search on MongoDB. It uses Azure OpenAI to generate vector embeddings from a text query and uses MongoDB Atlas's `$vectorSearch` to find documents based on conceptual meaning.

### Core Functionality

  * **Vector Generation**: Converts natural language queries into `text-embedding-ada-002` embeddings via the Azure OpenAI API.
  * **Index Management**: Programmatically creates a `vectorSearch` index on a collection, checking for its existence and polling its status until `READY`.
  * **Semantic Search**: Executes a `$vectorSearch` aggregation pipeline to find documents with the most similar vector embeddings.
  * **Cleanup**: Includes a prompt to drop the search index after the demonstration.

-----


## Setup & Run

### 1\. Prerequisites

* **MongoDB Tools:**
  * **mongosh:** The official MongoDB shell for interacting with MongoDB databases.
  * **mongorestore:** A tool for restoring data from a dump file to a MongoDB database.
* **Docker:** Installed on your system ([https://www.docker.com/products/docker-desktop/](https://www.docker.com/products/docker-desktop/))
* **wget or curl:** Installed on your system (package managers usually handle this)


### Setting Up a Local Atlas Environment

1. **Pull the Docker Image:**

   * **Latest Version:**
     ```bash
     docker pull mongodb/mongodb-atlas-local
     ```

2. **Run the Database:**

   ```bash
   docker run -p 27017:27017 mongodb/mongodb-atlas-local
   ```
   This command runs the Docker image, exposing port 27017 on your machine for connecting to the database.

### Using Sample Datasets with MongoDB

This section demonstrates downloading and exploring a sample dataset for MongoDB on your local system.

#### Downloading the Dataset

There's a complete sample dataset available for MongoDB. Download it using either `wget` or `curl`:

* **Using wget:**

```bash
wget https://atlas-education.s3.amazonaws.com/sampledata.archive
```

* **Using curl:**

```bash
curl https://atlas-education.s3.amazonaws.com/sampledata.archive -o sampledata.archive
```

**Note:**

* Ensure you have `wget` or `curl` installed.
* The downloaded file will be named `sampledata.archive`.

#### Restoring the Dataset

Before restoring, ensure you have a local `mongod` instance running (either existing or newly started). This instance will host the dataset.

**To restore the dataset:**

```bash
mongorestore --archive=sampledata.archive
```

This command uses the `mongorestore` tool to unpack the downloaded archive (`sampledata.archive`) and populate your local `mongod` instance with the sample data.


### 2\. Execute

Run the script from your terminal. It will guide you through index creation and the search.

```bash
python demo.py
```

-----

## Key Components

### Vector Index Definition

The script defines the `vectorSearch` index, specifying the vector field, dimensions, and similarity metric.

```python
# From the script
search_index_model = SearchIndexModel(
    name="vector_index_plot",
    type="vectorSearch",
    definition={
        "fields": [
            {
                "type": "vector",
                "path": "plot_embedding",
                "numDimensions": 1536,
                "similarity": "cosine",
            }
        ]
    }
)
```

### `$vectorSearch` Aggregation Pipeline

The core search logic is an aggregation pipeline that finds the top N results based on vector similarity and projects the search score.

  * `queryVector`: The embedding generated from the user's text query.
  * `numCandidates`: The number of nodes to inspect during the search for higher accuracy.
  * `$meta: "vectorSearchScore"`: Projects the similarity score of each result.

<!-- end list -->

```python
# From the script
pipeline = [
    {
        "$vectorSearch": {
            "index": "vector_index_plot",
            "path": "plot_embedding",
            "queryVector": query_vector, # Generated by Azure OpenAI
            "numCandidates": 150,
            "limit": 5,
        }
    },
    {
        "$project": {
            "title": 1,
            "plot": 1,
            "score": { "$meta": "vectorSearchScore" }
        }
    }
]
```

### Example Output

Searching for `"A tale of redemption and friendship in a prison."` yields the following:

```
--- Search Results ---
  ðŸŽ¬ Title: The Shawshank Redemption
      Score: 0.9416
      Plot: Two imprisoned men bond over a number of years, finding solace and eventual redemption through acts of common decency....

  ðŸŽ¬ Title: The Green Mile
      Score: 0.9023
      Plot: The lives of guards on Death Row are affected by one of their charges: a black man accused of child murder and rape, yet who has a mysterious gift....
```
